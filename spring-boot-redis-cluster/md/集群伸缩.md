1、伸缩原理
    Redis集群提供了灵活的节点扩容和收缩方案。在不影响集群对外服务的情况下，可以为集群添加节点进行扩容也可以下线部分节点进行缩容。
    Redis集群可以实现对节点的灵活上下线控制。其中原理可抽象为槽和对应数据在不同节点之间灵活移动。
    理解集群的水平伸缩的上层原理：集群伸缩=槽和数据在节点之间的移动，下面将介绍集群扩容和收缩的细节。

2、扩容集群
    扩容是分布式存储最常见的需求，Redis集群扩容操作可分为如下步骤：
    1）准备新节点。
    2）加入集群。
    3）迁移槽和数据。

    2.1 准备新节点
        需要提前准备好新节点并运行在集群模式下，新节点建议跟集群内的节点配置保持一致，便于管理统一。
        启动后的新节点作为孤儿节点运行，并没有其他节点与之通信。
    2.2 加入集群
        新节点依然采用cluster meet命令加入到现有集群中。
        集群内新旧节点经过一段时间的ping/pong消息通信之后，所有节点会发现新节点并将它们的状态保存到本地。
        新节点刚开始都是主节点状态，但是由于没有负责的槽，所以不能接受任何读写操作。对于新节点的后续操作我们一般有两种选择：
            ·为它迁移槽和数据实现扩容。
            ·作为其他主节点的从节点负责故障转移。
        redis-trib.rb工具也实现了为现有集群添加新节点的命令，还实现了直接添加为从节点的支持，命令如下：
            redis-trib.rb add-node new_host:new_port existing_host:existing_port --slave --master-id <arg>
        内部同样采用cluster meet命令实现加入集群功能。对于之前的加入集群 操作，我们可以采用如下命令实现新节点加入：
            redis-trib.rb add-node 127.0.0.1:6385 127.0.0.1:6379
            redis-trib.rb add-node 127.0.0.1:6386 127.0.0.1:6379
        如果我们手动执行cluster meet命令加入已经存在于其他集群的节点，会造成被加入节点的集群合并到现有集群的情况，从而造成数据丢失和错乱，
        后果非常严重，线上谨慎操作。
    2.3 迁移槽和数据
        加入集群后需要为新节点迁移槽和相关数据，槽在迁移过程中集群可以正常提供读写服务，迁移过程是集群扩容最核心的环节，下面详细讲解。
        （1）槽迁移计划
            槽是Redis集群管理数据的基本单位，首先需要为新节点制定槽的迁移计划，确定原有节点的哪些槽需要迁移到新节点。迁移计划需要确保每个节
            点负责相似数量的槽，从而保证各节点的数据均匀。
            槽迁移计划确定后开始逐个把槽内数据从源节点迁移到目标节点。
       （2）迁移数据
            数据迁移过程是逐个槽进行的
                流程说明：
                    1）对目标节点发送cluster setslot{slot}importing{sourceNodeId}命令，让目标节点准备导入槽的数据。
                    2）对源节点发送cluster setslot{slot}migrating{targetNodeId}命令，让源节点准备迁出槽的数据。
                    3）源节点循环执行cluster getkeysinslot{slot}{count}命令，获取count个属于槽{slot}的键。
                    4）在源节点上执行migrate{targetIp}{targetPort}""0{timeout}keys{keys...}命令，把获取的键通过
                    流水线（pipeline）机制批量迁移到目标节点，批量迁移版本的migrate命令在Redis3.0.6以上版本提供，
                    之前的migrate命令只能 单个键迁移。对于大量key的场景，批量键迁移将极大降低节点之间网络IO次数。
                    5）重复执行步骤3）和步骤4）直到槽下所有的键值数据迁移到目标节点。
                    6）向集群内所有主节点发送cluster setslot{slot}node{targetNodeId}命令，通知槽分配给目标节点。
                    为了保证槽节点映射变更及时传播，需要遍历发送给所有主节点更新被迁移的槽指向新节点。
            因此redis-trib提供了槽重分片功能，命令如下：
                redis-trib.rb reshard host:port --from <arg> --to <arg> --slots <arg> --yes --timeout <arg> --pipeline <arg>
       （3）添加从节点
            扩容之初我们把节点加入到集群，从别的节点迁移了部分槽和数据作为主节点，但相比其他主节点目前还没有从节点，因此该节点不具备
            故障转移的能力。
            使用cluster replicate{masterNodeId}命令为主节点添加对应从节点，注意在集群模式下slaveof添加从节点操作不再支持。

            当下线主节点具有从节点时需要把该从节点指向到其他主节点，因此对于主从节点都下线的情况，建议先下线从节点再下线主节点，防止不必要的全量复制。
